{
  "name": "My workflow",
  "nodes": [
    {
      "parameters": {
        "formTitle": "ROI form",
        "formFields": {
          "values": [
            {
              "fieldLabel": "Device Model",
              "placeholder": "e.g Iphone 13",
              "requiredField": true
            },
            {
              "fieldLabel": "Defects",
              "placeholder": "e.g \"Broken screen\"",
              "requiredField": true
            },
            {
              "fieldLabel": "Device price",
              "fieldType": "number",
              "placeholder": "e.g 100$",
              "requiredField": true
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.formTrigger",
      "typeVersion": 2.2,
      "position": [
        -3152,
        -240
      ],
      "id": "6f003974-740d-4383-a2ec-bb27a0422397",
      "name": "On form submission",
      "webhookId": "WEBHOOK ID HERE"
    },
    {
      "parameters": {
        "url": "=https://api.ebay.com/buy/browse/v1/item_summary/search?q=refurbished {{ $('Webhook').item.json.body.Device_Model }}  &limit=1",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.accessToken }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2624,
        80
      ],
      "id": "105dd8cb-91bc-4386-9c3d-e38e5b6942bc",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "jsCode": "const clientId = 'UmarFaro-ROIcalcu-PRD-00bd30580-17905c32';\nconst clientSecret ='PRD-0bd305807698-b1c8-49a0-a5e7-8d2c';\nconst basicAuth = Buffer.from(`${clientId}:${clientSecret}`).toString('base64');\n\nconst options = {\n  method: 'POST',\n  url: 'https://api.ebay.com/identity/v1/oauth2/token',\n  headers: {\n    'Content-Type': 'application/x-www-form-urlencoded',\n    'Authorization': `Basic ${basicAuth}`,\n  },\n  body: 'grant_type=client_credentials&scope=https://api.ebay.com/oauth/api_scope',\n  json: false // VERY IMPORTANT: body is raw string, so don't auto-parse it\n};\n\n  const staticGlobalData=$getWorkflowStaticData('global')\n  const expiry=staticGlobalData.expiry\nconst presenttime=new Date()\nconsole.log(staticGlobalData.tokenexpiry)\nif(staticGlobalData.tokenexpiry&&presenttime<new Date(staticGlobalData.tokenexpiry)){\n  return [{json:{accessToken:staticGlobalData.accesstoken,message:\"everythinggood\"}}]\n}\n\n\ntry {\n  const response = await this.helpers.httpRequest(options);\n \n\n\nconst accesstoken=response.access_token;\nconst tokenExpiry=response.expires_in;\nconst tokenRealExpiry=new Date(Date.now()+(tokenExpiry*1000))\nstaticGlobalData.accesstoken=accesstoken\nstaticGlobalData.tokenexpiry=tokenRealExpiry.toISOString() \n  return [{json:{accesstoken:response.access_token}}]; \n  \n} catch (error) {\n  \n  return [{erro:error}]\n}\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2832,
        80
      ],
      "id": "cbe52509-bfa2-42f5-b5c4-090371588422",
      "name": "Code1"
    },
    {
      "parameters": {
        "jsCode": "const response=$input.first()\nreturn [{json:{Refurbishedprice:response.json.itemSummaries[0].price.value}}]"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2448,
        96
      ],
      "id": "6e98f8aa-824a-474f-9bcb-f9e2f24c2fb6",
      "name": "Code"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Device model:{{ $('Webhook').item.json.body.Device_Model }}\nDefects:{{ $('Webhook').item.json.body.Defects }}\nTavilyRespone:{{ $json.answer }}",
        "options": {
          "systemMessage": "You are a real-time search agent tasked with finding the current market price of used or broken electronic devices that have specific defects or damage conditions.\n\nYou are provided with a market search result that has already been retrieved using the Tavily tool, which searched across trusted marketplaces (such as eBay, Swappa, BackMarket, Amazon Renewed) to locate listings or sold prices for devices matching the condition and defects described.\n\nðŸ” Objective:\nGiven:\n\nDevice model (e.g., \"iPhone 12 Pro\", \"Samsung Galaxy S21\")\n\nList of defects (e.g., \"cracked screen\", \"water damage\")\n\nYou must:\n\nRead the provided Tavily market response\n\nIdentify recent listings (preferably from the last 7â€“30 days) with similar defect conditions\n\nFocus on sold prices or active listings\n\nExtract the most common/average price in USD\n\nâš ï¸ Output Instruction:\nOnly return the estimated market price (in USD), nothing else.\n\nFormat:\n\nini\nprice = $[amount]\n\nâœ… Example Output:\n\nini\nprice = $130\n\nDo not include:\n\nExplanations\n\nLinks\n\nConfidence scores\n\nSummaries\n\nSuggestions\n\nJust the price. Be concise and consistent.\n\nðŸ“¦ Market data to analyze:\n\"{ {$json[\"tavily_response\"]} }\"\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.1,
      "position": [
        -1968,
        80
      ],
      "id": "766bcca1-296a-4f88-93f5-df5939ac10bd",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -1776,
        400
      ],
      "id": "8427765d-f451-402b-b3e4-5e546ec322fa",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "PBnWjwdaGsi46dua",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Device Model:{{ $('Webhook').item.json.body.Device_Model }}\nDefects:{{ $('Webhook').item.json.body.Defects }}",
        "options": {
          "systemMessage": "For the device model, infer the specific replacement parts required to repair the following defects:\n\ncracked screen\n\nbattery draining fast\n\nwonâ€™t charge\n\nblurry photos\n\nno sound during call\n\nReturn the result as a JSON array of objects in the following format:\n\n\n[\n  { \"part\": \"device model with part-name-1\" },\n  { \"part\": \"device model with part-name-2\" },\n  ...\n]\nDo not include duplicates or explanations. Only return the JSON."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.1,
      "position": [
        -1568,
        96
      ],
      "id": "2f95f639-0a73-4e4e-b4b7-c39993b4b19a",
      "name": "AI Agent1"
    },
    {
      "parameters": {
        "jsCode": "const data=$input.first().json.output\nconst raw = data.replace(/```json|```/g, '').trim();\nconst parts = JSON.parse(raw)\n\nreturn parts?.map(item => ({ json: item }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1104,
        96
      ],
      "id": "b701e254-9409-4195-8e24-1819e986cb8e",
      "name": "Code2"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -720,
        272
      ],
      "id": "0a1ae10b-8d70-4971-b1a0-c6e1d99a20c1",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.tavily.com/search",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "YOUR TAVILY API KEY"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"query\": \"Current price of  {{ $json.part }} in USD \",\n  \"auto_parameters\": false,\n  \"topic\": \"general\",\n  \"search_depth\": \"basic\",\n  \"chunks_per_source\": 3,\n  \"max_results\": 1,\n  \"time_range\": \"year\",\n  \"days\": 7,\n  \"include_answer\": true,\n  \"include_raw_content\": true,\n  \"include_images\": false,\n  \"include_image_descriptions\": false,\n  \"include_favicon\": false,\n  \"include_domains\": [\"ifixit.com\",\n    \"ebay.com\",\n    \"aliexpress.com\",\"idoctoruk.com\"],\n  \"exclude_domains\": [ \"reddit.com\",\n  \"quora.com\",\n  \"medium.com\",\n  \"tumblr.com\",\n  \"stackexchange.com\",\n  \"stackoverflow.com\",\n  \"twitter.com\",\n  \"facebook.com\",\"amazon.com\"],\n  \"country\": null\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -400,
        464
      ],
      "id": "bae7dd55-9ecd-49f9-8865-69bfb10706f7",
      "name": "HTTP Request2"
    },
    {
      "parameters": {
        "jsCode": "const allAnswers = $input.all().map(item => item.json.answer);\nconst combinedText = allAnswers.join(\"\\n\\n\");\n\nreturn [\n  {\n    json: {\n      combinedAnswers: combinedText\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -416,
        256
      ],
      "id": "ec8f25fa-bd6b-41c8-9448-89d35b71e5da",
      "name": "Code3"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "a037a1b7-4674-4c53-ab30-a481429fd3c3",
              "leftValue": "={{ $json.answer }}",
              "rightValue": "not available",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        32,
        496
      ],
      "id": "8f694b3a-a599-4f22-9cee-2fea72602194",
      "name": "If"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.tavily.com/search",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "YOUR TAVILY API KEY"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"query\": \"Current price of {{ $json.part }} \",\n  \"auto_parameters\": false,\n  \"topic\": \"general\",\n  \"search_depth\": \"basic\",\n  \"chunks_per_source\": 3,\n  \"max_results\": 1,\n  \"time_range\": null,\n  \"days\": 7,\n  \"include_answer\": true,\n  \"include_raw_content\": true,\n  \"include_images\": false,\n  \"include_image_descriptions\": false,\n  \"include_favicon\": false,\n  \"include_domains\": [\"ifixit.com\",\n    \"ebay.com\",\n    \"aliexpress.com\",\n    \"swappa.com\"],\n  \"exclude_domains\": [ \"reddit.com\",\n  \"quora.com\",\n  \"medium.com\",\n  \"tumblr.com\",\n  \"stackexchange.com\",\n  \"stackoverflow.com\",\n  \"twitter.com\",\n  \"facebook.com\",\"amazon.com\"],\n  \"country\": null\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -16,
        912
      ],
      "id": "33035d82-0ae9-4804-8ed3-6402ae031162",
      "name": "HTTP Request1"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=partscost:{{ $json.combinedAnswers }}\nproductcost:{{ $('Webhook').item.json.body.device_Price }}\nrefurbishedprice: {{ $('Code').first().json.Refurbishedprice }}\nusedprice: {{ $('AI Agent').first().json.output }}",
        "options": {
          "systemMessage": "Extract the following values from the text:\n\n- Product cost\n- Part cost\n- Refurbished price\n- Used price\n\nReturn only a JSON object in the following format:\n{\n  \"product_cost\": \"...\",\n  \"part_cost\": \"...\",\n  \"refurbished_price\": \"...\",\n  \"used_price\": \"...\"\n}\nYou can also include a sample like:\n\ntxt\nCopy\nEdit\nExample Output:\n{\n  \"product_cost\": \"100$\",\n  \"part_cost\": \"200$\",\n  \"refurbished_price\": \"300$\",\n  \"used_price\": \"200$\"\n}\nEnsure:\n- part_cost is the **sum** of all listed part prices.\n- Do **not** include any explanation or extra text â€” only return valid JSON.\n- All prices should include the \"$\" symbol."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.1,
      "position": [
        96,
        288
      ],
      "id": "f049e2b8-bfcb-4bd6-a192-57c91cedb7d5",
      "name": "AI Agent2"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        240,
        608
      ],
      "id": "284f80a8-7e71-498c-a66e-07a905efbdde",
      "name": "Google Gemini Chat Model2",
      "credentials": {
        "googlePalmApi": {
          "id": "PBnWjwdaGsi46dua",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const data=$input.first().json.output\nconst raw = data.replace(/```json|```/g, '').trim();\nconst obj = JSON.parse(raw);\nreturn [{ json: obj }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        464,
        272
      ],
      "id": "bdb64c67-baeb-450b-9d89-7ad2ee4e41e5",
      "name": "Code4"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://roi-caculator-ymlr.vercel.app/api/roiSummary",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "cost_price",
              "value": "={{ $json.product_cost }}"
            },
            {
              "name": "refurbished_price",
              "value": "={{ $json.refurbished_price }}"
            },
            {
              "name": "parts_cost",
              "value": "={{ $json.part_cost }}"
            },
            {
              "name": "used_price",
              "value": "={{ $json.used_price }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        464,
        752
      ],
      "id": "1aeb60f8-b5c9-4ff9-a581-ccaced80a9af",
      "name": "HTTP Request3"
    },
    
    {
      "parameters": {
        "jsCode": "const markdown =  $input.first().json.summary\n\nconst { marked } = require(\"marked\"); // built-in in n8n\n\nreturn [\n  {\n    json: {\n      html: marked.parse(markdown)\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        48,
        -224
      ],
      "id": "3ea3d2c5-f0b0-4b48-a273-ce757ba7effb",
      "name": "Code5"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.tavily.com/search",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "YOUR TAVILY API KEY"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n    \"query\": \"{{ $('Webhook').item.json.body.Device_Model }} with {{ $('Webhook').item.json.body.Defects }} price in USD\",\n  \"auto_parameters\": false,\n  \"topic\": \"general\",\n  \"search_depth\": \"basic\",\n  \"chunks_per_source\": 3,\n  \"max_results\": 1,\n  \"time_range\": null,\n  \"days\": 7,\n  \"include_answer\": true,\n  \"include_raw_content\": true,\n  \"include_images\": false,\n  \"include_image_descriptions\": false,\n  \"include_favicon\": false,\n  \"include_domains\": [\"bankmycell.com\"],\n  \"exclude_domains\": [],\n  \"country\": null\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2272,
        80
      ],
      "id": "89489162-007a-4545-b1e5-4ed6b796b0fc",
      "name": "HTTP Request4"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "1ffcb5ca-9ef2-4d2b-962e-2a0d1b5da4f7",
        "responseMode": "responseNode",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "text/html"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -3120,
        80
      ],
      "id": "6f1022e4-2c75-4a05-86df-581fdc941cb4",
      "name": "Webhook",
      "webhookId": "WEBHOOK ID HERE" 
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "=summary:{{ $json.summary }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "text/html"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        672,
        752
      ],
      "id": "a0278ce3-5bfa-46a3-8ca2-94ee189eb06f",
      "name": "Respond to Webhook"
    }
  ],
  "pinData": {},
  "connections": {
    "On form submission": {
      "main": [
        []
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code1": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "HTTP Request4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "AI Agent1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "AI Agent1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent1": {
      "main": [
        [
          {
            "node": "Code2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code2": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [
          {
            "node": "Code3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP Request2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request2": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code3": {
      "main": [
        [
          {
            "node": "AI Agent2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "HTTP Request1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request1": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent2",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent2": {
      "main": [
        [
          {
            "node": "Code4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code4": {
      "main": [
        [
          {
            "node": "HTTP Request3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request3": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request4": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "913e0130-c02a-4393-ad03-eb9d98e43990",
  "meta": {
    "instanceId": "ac2e958b8cc5335c3efbb7c7f1182538a4bbd62fc1320af4d3d7c0864f1e7d5a"
  },
  "id": "STXUL5Bv61uXxpmo",
  "tags": []
}